<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R8年 標準化予定 市町村マップ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif; }
#map { width: 100%; height: 100vh; }

#loading {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.92);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: #333;
}

.spinner {
  width: 40px; height: 40px;
  border: 4px solid #ddd;
  border-top-color: #2196F3;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 12px;
}

@keyframes spin { to { transform: rotate(360deg); } }

.sidebar {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1000;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  padding: 12px;
  max-height: calc(100vh - 20px);
  overflow-y: auto;
  width: 300px;
  font-size: 13px;
}

.sidebar h2 {
  font-size: 15px;
  margin-bottom: 8px;
  border-bottom: 2px solid #333;
  padding-bottom: 6px;
}

.sidebar .stats {
  margin-bottom: 10px;
  color: #555;
  font-size: 12px;
}

.legend-section {
  margin-bottom: 10px;
}

.legend-section h3 {
  font-size: 13px;
  margin-bottom: 4px;
  color: #333;
}

.legend-item {
  display: flex;
  align-items: center;
  margin: 3px 0;
  font-size: 12px;
  cursor: pointer;
  padding: 2px 4px;
  border-radius: 4px;
  transition: background 0.2s;
}

.legend-item:hover {
  background: #f0f0f0;
}

.legend-color {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  margin-right: 6px;
  border: 1px solid rgba(0,0,0,0.2);
  flex-shrink: 0;
}

.search-box {
  width: 100%;
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin-bottom: 8px;
  font-size: 13px;
}

.search-box:focus {
  outline: none;
  border-color: #4A90D9;
}

.municipality-list {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #eee;
  border-radius: 4px;
}

.muni-item {
  padding: 5px 8px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
  font-size: 12px;
  transition: background 0.15s;
}

.muni-item:hover {
  background: #e8f0fe;
}

.muni-item .pref {
  color: #888;
  font-size: 11px;
}

.custom-popup .leaflet-popup-content-wrapper {
  border-radius: 8px;
  box-shadow: 0 3px 14px rgba(0,0,0,0.25);
}

.popup-content {
  font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
  min-width: 180px;
}

.popup-content h3 {
  font-size: 16px;
  margin-bottom: 4px;
  color: #1a1a1a;
}

.popup-content .pref-name {
  font-size: 12px;
  color: #666;
  margin-bottom: 8px;
}

.popup-content .date-info {
  background: #f5f7fa;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 13px;
}

.popup-content .date-label {
  font-size: 11px;
  color: #888;
}

.popup-content .date-value {
  font-size: 15px;
  font-weight: bold;
  color: #2c5aa0;
}

.density-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  margin-top: 6px;
  color: white;
  font-weight: bold;
}

.neighbor-info {
  margin-top: 8px;
  padding: 6px 10px;
  background: #f9f9f9;
  border-radius: 4px;
  border-left: 3px solid #999;
}

.neighbor-label {
  font-size: 11px;
  color: #555;
  margin-bottom: 3px;
}

.neighbor-list {
  font-size: 12px;
  color: #333;
  line-height: 1.5;
}

.info-box {
  position: absolute;
  bottom: 20px;
  left: 10px;
  z-index: 1000;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  padding: 10px 14px;
  font-size: 12px;
  color: #555;
}

.info-box strong {
  color: #333;
}

.density-legend {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 6px;
}

.density-legend-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
}

.density-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 1px solid rgba(0,0,0,0.15);
}

.density-definition {
  margin-bottom: 8px;
}

.def-box {
  background: #fff8e1;
  border: 1px solid #ffe082;
  border-radius: 6px;
  padding: 8px 10px;
  margin-top: 4px;
}

.def-title {
  font-size: 12px;
  font-weight: bold;
  color: #e65100;
  margin-bottom: 4px;
}

.def-body {
  font-size: 11px;
  color: #555;
  line-height: 1.6;
}

.map-note {
  margin-top: 6px;
  font-size: 10px;
  color: #999;
  line-height: 1.5;
}
</style>
</head>
<body>
<div id="loading">
  <div class="spinner"></div>
  市町村境界データを読み込み中...
</div>
<div id="map"></div>

<div class="sidebar" id="sidebar">
  <h2>R8年 標準化予定市町村</h2>
  <div class="stats" id="stats"></div>

  <input type="text" class="search-box" id="searchBox" placeholder="市町村名で検索...">

  <div class="legend-section">
    <h3>密集度による色分け</h3>
    <div class="density-definition">
      <div class="def-box">
        <div class="def-title">「密集」の定義</div>
        <div class="def-body">
          対象80市町村の行政区域ポリゴンで<br>
          <strong>実際に境界を共有する</strong>市町村同士を<br>
          「隣接」としてグラフ化し、<strong>連なり<br>
          （クラスター）が3市町村以上</strong>で<br>
          あれば、そのクラスター全体を<br>
          「密集」と判定しています。<br>
          <br>
          ※ 端の市町村（隣接が1つだけ）でも<br>
          クラスター全体が3以上なら密集扱い。<br>
          ※ 距離制限は使用していません。<br>
          <br>
          地図上では該当市町村の領域全体を<br>
          赤色（密集）または青色（非密集）で<br>
          塗りつぶして表示しています。
        </div>
      </div>
    </div>
    <div class="density-legend">
      <div class="density-legend-item"><div class="density-dot" style="background:#d32f2f"></div><strong>密集</strong>：クラスター3市町村以上</div>
      <div class="density-legend-item"><div class="density-dot" style="background:#2196F3"></div><strong>非密集</strong>：クラスター2市町村以下</div>
    </div>
    <div class="map-note">
      ※ 市町村境界データ: 国土数値情報（国土交通省）<br>
      ※ 背景地図: 国土地理院タイル
    </div>
  </div>

  <div class="legend-section">
    <h3>都道府県別（クリックで移動）</h3>
    <div id="prefLegend"></div>
  </div>

  <h3 style="margin-top:8px; margin-bottom:4px; font-size:13px;">市町村一覧</h3>
  <div class="municipality-list" id="muniList"></div>
</div>

<div class="info-box">
  <strong>操作方法:</strong> 色付きの市町村をクリックで詳細表示 / スクロールでズーム / 右のリストから市町村を選択
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
<script>
// Data: parsed from Excel
const municipalities = [
  {pref:"北海道",name:"安平町",date:46339,lat:42.7631,lng:141.8233},
  {pref:"北海道",name:"えりも町",date:46339,lat:42.0142,lng:143.1461},
  {pref:"北海道",name:"美瑛町",date:46339,lat:43.5873,lng:142.4685},
  {pref:"北海道",name:"新得町",date:46339,lat:43.0792,lng:142.8386},
  {pref:"北海道",name:"更別村",date:46339,lat:42.7297,lng:143.1997},
  {pref:"北海道",name:"浜中町",date:46339,lat:43.0756,lng:145.1247},
  {pref:"北海道",name:"標茶町",date:46339,lat:43.2970,lng:144.5983},
  {pref:"北海道",name:"別海町",date:46339,lat:43.3917,lng:145.1186},
  {pref:"北海道",name:"中標津町",date:46339,lat:43.5561,lng:144.9722},
  {pref:"北海道",name:"三笠市",date:46353,lat:43.2453,lng:141.8789},
  {pref:"北海道",name:"寿都町",date:46353,lat:42.7914,lng:140.2306},
  {pref:"北海道",name:"広尾町",date:46360,lat:42.2847,lng:143.3114},
  {pref:"北海道",name:"標津町",date:46367,lat:43.6611,lng:145.1317},
  {pref:"北海道",name:"羅臼町",date:46367,lat:44.0233,lng:145.1856},
  {pref:"青森県",name:"つがる市",date:46373,lat:40.8072,lng:140.3822},
  {pref:"青森県",name:"鰺ヶ沢町",date:46374,lat:40.7803,lng:140.2092},
  {pref:"青森県",name:"深浦町",date:46374,lat:40.6464,lng:139.9275},
  {pref:"青森県",name:"鶴田町",date:46374,lat:40.7589,lng:140.4306},
  {pref:"岩手県",name:"雫石町",date:46367,lat:39.6956,lng:140.9625},
  {pref:"宮城県",name:"七ヶ浜町",date:46338,lat:38.3017,lng:141.0536},
  {pref:"宮城県",name:"蔵王町",date:46381,lat:38.1003,lng:140.6553},
  {pref:"秋田県",name:"上小阿仁村",date:46381,lat:39.9428,lng:140.3378},
  {pref:"福島県",name:"浅川町",date:46338,lat:37.0733,lng:140.4119},
  {pref:"新潟県",name:"粟島浦村",date:46360,lat:38.4519,lng:139.2444},
  {pref:"石川県",name:"加賀市",date:46366,lat:36.3028,lng:136.3144},
  {pref:"長野県",name:"坂城町",date:46367,lat:36.4636,lng:138.1808},
  {pref:"愛知県",name:"幸田町",date:46339,lat:34.8608,lng:137.1633},
  {pref:"三重県",name:"多気町",date:46374,lat:34.4828,lng:136.5783},
  {pref:"三重県",name:"明和町",date:46374,lat:34.5444,lng:136.6278},
  {pref:"三重県",name:"大台町",date:46374,lat:34.3747,lng:136.4042},
  {pref:"三重県",name:"玉城町",date:46374,lat:34.4853,lng:136.6256},
  {pref:"三重県",name:"度会町",date:46374,lat:34.4019,lng:136.5906},
  {pref:"三重県",name:"大紀町",date:46374,lat:34.3131,lng:136.4000},
  {pref:"三重県",name:"松阪市",date:46380,lat:34.5781,lng:136.5308},
  {pref:"三重県",name:"鳥羽市",date:46380,lat:34.4811,lng:136.8431},
  {pref:"鳥取県",name:"江府町",date:46346,lat:35.2722,lng:133.4878},
  {pref:"鳥取県",name:"大山町",date:46366,lat:35.3889,lng:133.5072},
  {pref:"鳥取県",name:"境港市",date:46380,lat:35.5392,lng:133.2317},
  {pref:"鳥取県",name:"琴浦町",date:46381,lat:35.4956,lng:133.6867},
  {pref:"鳥取県",name:"日南町",date:46381,lat:35.1414,lng:133.3000},
  {pref:"岡山県",name:"和気町",date:46374,lat:34.7994,lng:134.1544},
  {pref:"岡山県",name:"西粟倉村",date:46374,lat:35.1775,lng:134.3350},
  {pref:"岡山県",name:"吉備中央町",date:46374,lat:34.8558,lng:133.6856},
  {pref:"岡山県",name:"浅口市",date:46380,lat:34.5250,lng:133.5833},
  {pref:"広島県",name:"三次市",date:46359,lat:34.8019,lng:132.8508},
  {pref:"広島県",name:"坂町",date:46374,lat:34.3389,lng:132.5119},
  {pref:"広島県",name:"三原市",date:46379,lat:34.3978,lng:133.0781},
  {pref:"山口県",name:"萩市",date:46352,lat:34.4081,lng:131.3992},
  {pref:"徳島県",name:"北島町",date:46374,lat:34.1317,lng:134.5539},
  {pref:"香川県",name:"土庄町",date:46374,lat:34.4856,lng:134.1839},
  {pref:"香川県",name:"小豆島町",date:46374,lat:34.4644,lng:134.2508},
  {pref:"愛媛県",name:"大洲市",date:46345,lat:33.5058,lng:132.5458},
  {pref:"愛媛県",name:"東温市",date:46345,lat:33.7878,lng:132.8678},
  {pref:"愛媛県",name:"久万高原町",date:46346,lat:33.6458,lng:132.9017},
  {pref:"愛媛県",name:"内子町",date:46346,lat:33.5319,lng:132.6544},
  {pref:"愛媛県",name:"八幡浜市",date:46352,lat:33.4608,lng:132.4236},
  {pref:"高知県",name:"佐川町",date:46353,lat:33.5006,lng:133.2808},
  {pref:"福岡県",name:"大牟田市",date:46345,lat:33.0303,lng:130.4461},
  {pref:"福岡県",name:"みやま市",date:46345,lat:33.1556,lng:130.4739},
  {pref:"福岡県",name:"飯塚市",date:46352,lat:33.6458,lng:130.6914},
  {pref:"長崎県",name:"東彼杵町",date:46353,lat:33.0672,lng:129.9231},
  {pref:"長崎県",name:"川棚町",date:46353,lat:33.0744,lng:129.8656},
  {pref:"長崎県",name:"佐々町",date:46353,lat:33.2197,lng:129.6478},
  {pref:"長崎県",name:"波佐見町",date:46360,lat:33.1486,lng:129.8944},
  {pref:"長崎県",name:"新上五島町",date:46360,lat:32.9778,lng:129.0722},
  {pref:"熊本県",name:"相良村",date:46283,lat:32.2719,lng:130.8092},
  {pref:"熊本県",name:"南阿蘇村",date:46339,lat:32.8522,lng:131.0383},
  {pref:"熊本県",name:"阿蘇市",date:46345,lat:32.9489,lng:131.1239},
  {pref:"熊本県",name:"西原村",date:46346,lat:32.8358,lng:130.9128},
  {pref:"熊本県",name:"上天草市",date:46352,lat:32.5778,lng:130.4378},
  {pref:"熊本県",name:"大津町",date:46353,lat:32.8764,lng:130.8686},
  {pref:"熊本県",name:"湯前町",date:46360,lat:32.2536,lng:131.0000},
  {pref:"熊本県",name:"山江村",date:46360,lat:32.2206,lng:130.8186},
  {pref:"熊本県",name:"球磨村",date:46360,lat:32.2728,lng:130.7103},
  {pref:"熊本県",name:"美里町",date:46374,lat:32.6158,lng:130.8194},
  {pref:"鹿児島県",name:"指宿市",date:46282,lat:31.2519,lng:130.6319},
  {pref:"鹿児島県",name:"肝付町",date:46360,lat:31.1858,lng:130.9875},
  {pref:"鹿児島県",name:"長島町",date:46374,lat:32.2003,lng:130.1683},
  {pref:"鹿児島県",name:"天城町",date:46374,lat:27.3906,lng:128.8819},
  {pref:"沖縄県",name:"沖縄市",date:46352,lat:26.3342,lng:127.8056}
];

// Convert Excel serial to date string
function excelDateToString(serial) {
  const epoch = new Date(1899, 11, 30);
  const d = new Date(epoch.getTime() + serial * 86400000);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return y + '年' + m + '月' + day + '日';
}

// Prefecture colors
const prefColors = {};
const colorPalette = [
  '#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd',
  '#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf',
  '#393b79','#637939','#8c6d31','#843c39','#7b4173',
  '#5254a3','#6b6ecf','#9c9ede','#31a354','#756bb1',
  '#636363','#e6550d','#3182bd','#e7969c','#c7e9c0'
];

const prefList = [...new Set(municipalities.map(m => m.pref))];
prefList.forEach((p, i) => {
  prefColors[p] = colorPalette[i % colorPalette.length];
});

// Initialize – density will be computed after TopoJSON load
municipalities.forEach(m => {
  m.dateStr = excelDateToString(m.date);
  m.neighbors = 0;
  m.neighborNames = [];
  m.clusterSize = 1;
  m.clusterMembers = [m.name];
  m.density = 'sparse';
  m.densityColor = '#2196F3';
  m.densityLabel = '非密集';
});

// Build lookup: key = municipality name to match GeoJSON
const muniLookup = {};
municipalities.forEach(m => {
  muniLookup[m.name] = m;
  // Also store with pref prefix for disambiguation
  muniLookup[m.pref + '_' + m.name] = m;
});

// Map
const map = L.map('map', {
  zoomControl: true
}).setView([36.5, 137.0], 6);

// 国土地理院 淡色地図
const gsiPale = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
  attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',
  maxZoom: 18
});

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors',
  maxZoom: 18
});

const gsiStd = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
  attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',
  maxZoom: 18
});

gsiPale.addTo(map);

const baseMaps = {
  '国土地理院 淡色地図（推奨）': gsiPale,
  '国土地理院 標準地図': gsiStd,
  'OpenStreetMap': osm
};
L.control.layers(baseMaps, null, { position: 'topleft' }).addTo(map);

// Store polygon layers for click-from-list
const polygonLayers = {};

// Fetch TopoJSON (high-precision s0010, ~1.5MB) and convert to GeoJSON
const TOPOJSON_URL = 'https://cdn.jsdelivr.net/gh/smartnews-smri/japan-topography@main/data/municipality/topojson/s0010/N03-21_210101.json';

fetch(TOPOJSON_URL)
  .then(res => res.json())
  .then(topo => {
    const objectKey = Object.keys(topo.objects)[0];
    const geometries = topo.objects[objectKey].geometries;
    const geojson = topojson.feature(topo, topo.objects[objectKey]);

    // ---- Step A: Map each TopoJSON geometry index to our municipality ----
    // featureIndex -> matched municipality, or null
    const featureToMuni = new Array(geometries.length).fill(null);
    // municipality name -> list of feature indices (some munis have multiple polygons)
    const muniToFeatures = {};

    geometries.forEach((geom, fi) => {
      const props = geom.properties;
      const cityName = props.N03_003 || '';
      const townName = props.N03_004 || '';
      const prefName = props.N03_001 || '';
      let matched = null;
      if (townName && muniLookup[townName]) {
        const c = muniLookup[townName];
        if (c.pref === prefName) matched = c;
      }
      if (!matched && cityName && muniLookup[cityName]) {
        const c = muniLookup[cityName];
        if (c.pref === prefName) matched = c;
      }
      if (matched) {
        featureToMuni[fi] = matched;
        const mk = matched.pref + '_' + matched.name;
        if (!muniToFeatures[mk]) muniToFeatures[mk] = [];
        muniToFeatures[mk].push(fi);
      }
    });

    // ---- Step B: Use topojson.neighbors() for real boundary adjacency ----
    const topoNeighbors = topojson.neighbors(geometries);

    // Build adjacency between our 80 municipalities (by name key)
    const muniAdj = {}; // key -> Set of neighbor keys
    municipalities.forEach(m => {
      muniAdj[m.pref + '_' + m.name] = new Set();
    });

    geometries.forEach((geom, fi) => {
      const mA = featureToMuni[fi];
      if (!mA) return;
      const keyA = mA.pref + '_' + mA.name;
      (topoNeighbors[fi] || []).forEach(ni => {
        const mB = featureToMuni[ni];
        if (!mB) return;
        const keyB = mB.pref + '_' + mB.name;
        if (keyA !== keyB) {
          muniAdj[keyA].add(keyB);
          muniAdj[keyB].add(keyA);
        }
      });
    });

    // Store neighbor info on each municipality
    municipalities.forEach(m => {
      const key = m.pref + '_' + m.name;
      const adjSet = muniAdj[key] || new Set();
      m.neighborNames = [...adjSet].map(k => {
        const parts = k.split('_');
        return parts.slice(1).join('_');
      });
      m.neighbors = m.neighborNames.length;
    });

    // ---- Step C: BFS to find clusters ----
    const muniKeys = municipalities.map(m => m.pref + '_' + m.name);
    const keyToIdx = {};
    muniKeys.forEach((k, i) => { keyToIdx[k] = i; });
    const vis = new Array(municipalities.length).fill(false);
    const clusters = [];

    municipalities.forEach((m, i) => {
      if (vis[i]) return;
      const queue = [i];
      const cluster = [];
      vis[i] = true;
      while (queue.length > 0) {
        const cur = queue.shift();
        cluster.push(cur);
        const curKey = muniKeys[cur];
        (muniAdj[curKey] || new Set()).forEach(nbKey => {
          const ni = keyToIdx[nbKey];
          if (ni !== undefined && !vis[ni]) {
            vis[ni] = true;
            queue.push(ni);
          }
        });
      }
      clusters.push(cluster);
    });

    clusters.forEach(cluster => {
      const isDense = cluster.length >= 3;
      cluster.forEach(idx => {
        const m = municipalities[idx];
        if (isDense) {
          m.density = 'dense';
          m.densityColor = '#d32f2f';
          m.densityLabel = '密集';
        } else {
          m.density = 'sparse';
          m.densityColor = '#2196F3';
          m.densityLabel = '非密集';
        }
        m.clusterSize = cluster.length;
        m.clusterMembers = cluster.map(ci => municipalities[ci].name);
      });
    });

    // ---- Step D: Render polygons with computed colors ----
    const geoLayer = L.geoJSON(geojson, {
      style: function(feature) {
        return { fillOpacity: 0, weight: 0, opacity: 0 };
      },
      onEachFeature: function(feature, layer) {
        const props = feature.properties;
        const cityName = props.N03_003 || '';
        const townName = props.N03_004 || '';
        const prefName = props.N03_001 || '';
        let matched = null;
        if (townName && muniLookup[townName]) {
          const c = muniLookup[townName];
          if (c.pref === prefName) matched = c;
        }
        if (!matched && cityName && muniLookup[cityName]) {
          const c = muniLookup[cityName];
          if (c.pref === prefName) matched = c;
        }
        if (!matched) return;

        layer.setStyle({
          fillColor: matched.densityColor,
          fillOpacity: 0.55,
          color: '#333',
          weight: 2,
          opacity: 0.8
        });

        layer.on('mouseover', function() {
          this.setStyle({ fillOpacity: 0.8, weight: 3 });
          this.bringToFront();
        });
        layer.on('mouseout', function() {
          this.setStyle({ fillOpacity: 0.55, weight: 2 });
        });

        var clusterSection = matched.clusterSize > 1
          ? '<div class="neighbor-info">' +
            '<div class="neighbor-label">所属クラスター: <strong>' + matched.clusterSize + '市町村</strong></div>' +
            '<div class="neighbor-list">' + matched.clusterMembers.filter(function(n){return n !== matched.name}).join('、') + '</div>' +
            '</div>'
          : '<div class="neighbor-info"><div class="neighbor-label">所属クラスター: <strong>なし（単独）</strong></div></div>';

        var neighborSection = matched.neighbors > 0
          ? '<div class="neighbor-info">' +
            '<div class="neighbor-label">境界を共有する隣接市町村: <strong>' + matched.neighbors + '件</strong></div>' +
            '<div class="neighbor-list">' + matched.neighborNames.join('、') + '</div>' +
            '</div>'
          : '';

        var popupContent =
          '<div class="popup-content">' +
          '<h3>' + matched.name + '</h3>' +
          '<div class="pref-name">' + matched.pref + '</div>' +
          '<div class="date-info">' +
          '<div class="date-label">利用開始日</div>' +
          '<div class="date-value">' + matched.dateStr + '</div>' +
          '</div>' +
          '<div class="density-badge" style="background:' + matched.densityColor + '">' +
          matched.densityLabel + '（クラスター ' + matched.clusterSize + ' 市町村）' +
          '</div>' +
          clusterSection +
          neighborSection +
          '</div>';

        layer.bindPopup(popupContent, { className: 'custom-popup', maxWidth: 320 });

        var key = matched.pref + '_' + matched.name;
        if (!polygonLayers[key]) polygonLayers[key] = [];
        polygonLayers[key].push(layer);
      }
    }).addTo(map);

    // Hide loading
    document.getElementById('loading').style.display = 'none';

    // Fallback for unmatched
    var matchedNames = new Set();
    Object.keys(polygonLayers).forEach(function(k) {
      matchedNames.add(k.split('_').slice(1).join('_'));
    });
    var unmatched = municipalities.filter(function(m) { return !matchedNames.has(m.name); });
    if (unmatched.length > 0) {
      console.log('Unmatched (fallback):', unmatched.map(function(m){return m.pref+' '+m.name}));
      unmatched.forEach(function(m) {
        var circle = L.circleMarker([m.lat, m.lng], {
          radius: 12, fillColor: m.densityColor, fillOpacity: 0.7, color: '#333', weight: 2
        });
        var popupContent =
          '<div class="popup-content">' +
          '<h3>' + m.name + '</h3>' +
          '<div class="pref-name">' + m.pref + '</div>' +
          '<div class="date-info"><div class="date-label">利用開始日</div><div class="date-value">' + m.dateStr + '</div></div>' +
          '<div class="density-badge" style="background:' + m.densityColor + '">' + m.densityLabel + '（クラスター ' + m.clusterSize + ' 市町村）</div>' +
          '</div>';
        circle.bindPopup(popupContent, { className: 'custom-popup', maxWidth: 320 });
        circle.addTo(map);
        var key = m.pref + '_' + m.name;
        if (!polygonLayers[key]) polygonLayers[key] = [];
        polygonLayers[key].push(circle);
      });
    }
  })
  .catch(err => {
    console.error('GeoJSON load error:', err);
    document.getElementById('loading').innerHTML = '<div style="color:red">境界データの読み込みに失敗しました。<br>ページをリロードしてください。</div>';
  });

// Stats
document.getElementById('stats').innerHTML =
  '全 <strong>' + municipalities.length + '</strong> 市町村 / <strong>' + prefList.length + '</strong> 都道府県';

// Prefecture legend
const prefLegendEl = document.getElementById('prefLegend');
prefList.forEach(pref => {
  const count = municipalities.filter(m => m.pref === pref).length;
  const item = document.createElement('div');
  item.className = 'legend-item';
  item.innerHTML = '<div class="legend-color" style="background:' + prefColors[pref] + '"></div>' + pref + ' (' + count + ')';
  item.addEventListener('click', function() {
    const prefMunis = municipalities.filter(m => m.pref === pref);
    const bounds = L.latLngBounds(prefMunis.map(m => [m.lat, m.lng]));
    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 10 });
  });
  prefLegendEl.appendChild(item);
});

// Municipality list
function renderMuniList(filter) {
  filter = filter || '';
  const listEl = document.getElementById('muniList');
  listEl.innerHTML = '';
  const filtered = municipalities.filter(m =>
    m.name.indexOf(filter) !== -1 || m.pref.indexOf(filter) !== -1
  );
  filtered.forEach(m => {
    const item = document.createElement('div');
    item.className = 'muni-item';
    item.innerHTML = '<span class="pref">' + m.pref + '</span> <strong>' + m.name + '</strong>';
    item.addEventListener('click', function() {
      const key = m.pref + '_' + m.name;
      if (polygonLayers[key] && polygonLayers[key].length > 0) {
        // Fit bounds to all polygon pieces
        const group = L.featureGroup(polygonLayers[key]);
        map.fitBounds(group.getBounds(), { padding: [50, 50], maxZoom: 12 });
        // Open popup on first polygon
        polygonLayers[key][0].openPopup();
      } else {
        // Fallback to lat/lng
        map.setView([m.lat, m.lng], 12);
      }
    });
    listEl.appendChild(item);
  });
}

renderMuniList();

document.getElementById('searchBox').addEventListener('input', function(e) {
  renderMuniList(e.target.value);
});
</script>
</body>
</html>
