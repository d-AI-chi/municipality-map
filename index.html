<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R8年 標準化予定 市町村マップ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif; }
#map { width: 100%; height: 100vh; }

.sidebar {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1000;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  padding: 12px;
  max-height: calc(100vh - 20px);
  overflow-y: auto;
  width: 280px;
  font-size: 13px;
}

.sidebar h2 {
  font-size: 15px;
  margin-bottom: 8px;
  border-bottom: 2px solid #333;
  padding-bottom: 6px;
}

.sidebar .stats {
  margin-bottom: 10px;
  color: #555;
  font-size: 12px;
}

.legend-section {
  margin-bottom: 10px;
}

.legend-section h3 {
  font-size: 13px;
  margin-bottom: 4px;
  color: #333;
}

.legend-item {
  display: flex;
  align-items: center;
  margin: 3px 0;
  font-size: 12px;
  cursor: pointer;
  padding: 2px 4px;
  border-radius: 4px;
  transition: background 0.2s;
}

.legend-item:hover {
  background: #f0f0f0;
}

.legend-color {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  margin-right: 6px;
  border: 1px solid rgba(0,0,0,0.2);
  flex-shrink: 0;
}

.search-box {
  width: 100%;
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin-bottom: 8px;
  font-size: 13px;
}

.search-box:focus {
  outline: none;
  border-color: #4A90D9;
}

.municipality-list {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #eee;
  border-radius: 4px;
}

.muni-item {
  padding: 5px 8px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
  font-size: 12px;
  transition: background 0.15s;
}

.muni-item:hover {
  background: #e8f0fe;
}

.muni-item .pref {
  color: #888;
  font-size: 11px;
}

.custom-popup .leaflet-popup-content-wrapper {
  border-radius: 8px;
  box-shadow: 0 3px 14px rgba(0,0,0,0.25);
}

.popup-content {
  font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
  min-width: 180px;
}

.popup-content h3 {
  font-size: 16px;
  margin-bottom: 4px;
  color: #1a1a1a;
}

.popup-content .pref-name {
  font-size: 12px;
  color: #666;
  margin-bottom: 8px;
}

.popup-content .date-info {
  background: #f5f7fa;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 13px;
}

.popup-content .date-label {
  font-size: 11px;
  color: #888;
}

.popup-content .date-value {
  font-size: 15px;
  font-weight: bold;
  color: #2c5aa0;
}

.density-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  margin-top: 6px;
  color: white;
  font-weight: bold;
}

.neighbor-info {
  margin-top: 8px;
  padding: 6px 10px;
  background: #f9f9f9;
  border-radius: 4px;
  border-left: 3px solid #999;
}

.neighbor-label {
  font-size: 11px;
  color: #555;
  margin-bottom: 3px;
}

.neighbor-list {
  font-size: 12px;
  color: #333;
  line-height: 1.5;
}

.toggle-sidebar {
  position: absolute;
  top: 10px;
  right: 300px;
  z-index: 1001;
  background: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toggle-sidebar:hover {
  background: #f0f0f0;
}

.info-box {
  position: absolute;
  bottom: 20px;
  left: 10px;
  z-index: 1000;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  padding: 10px 14px;
  font-size: 12px;
  color: #555;
}

.info-box strong {
  color: #333;
}

.density-legend {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 6px;
}

.density-legend-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
}

.density-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 1px solid rgba(0,0,0,0.15);
}
</style>
</head>
<body>
<div id="map"></div>

<div class="sidebar" id="sidebar">
  <h2>R8年 標準化予定市町村</h2>
  <div class="stats" id="stats"></div>

  <input type="text" class="search-box" id="searchBox" placeholder="市町村名で検索...">

  <div class="legend-section">
    <h3>密集度による色分け</h3>
    <div class="density-legend">
      <div class="density-legend-item"><div class="density-dot" style="background:#d32f2f"></div>密集（隣接3市町村以上）</div>
      <div class="density-legend-item"><div class="density-dot" style="background:#2196F3"></div>非密集（隣接2市町村以下）</div>
    </div>
  </div>

  <div class="legend-section">
    <h3>都道府県別（クリックで移動）</h3>
    <div id="prefLegend"></div>
  </div>

  <h3 style="margin-top:8px; margin-bottom:4px; font-size:13px;">市町村一覧</h3>
  <div class="municipality-list" id="muniList"></div>
</div>

<div class="info-box">
  <strong>操作方法:</strong> マーカーをクリックで詳細表示 / スクロールでズーム / 右のリストから市町村を選択
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// Data: parsed from Excel
const municipalities = [
  // Hokkaido
  {pref:"北海道",name:"安平町",date:46339,lat:42.7631,lng:141.8233},
  {pref:"北海道",name:"えりも町",date:46339,lat:42.0142,lng:143.1461},
  {pref:"北海道",name:"美瑛町",date:46339,lat:43.5873,lng:142.4685},
  {pref:"北海道",name:"新得町",date:46339,lat:43.0792,lng:142.8386},
  {pref:"北海道",name:"更別村",date:46339,lat:42.7297,lng:143.1997},
  {pref:"北海道",name:"浜中町",date:46339,lat:43.0756,lng:145.1247},
  {pref:"北海道",name:"標茶町",date:46339,lat:43.2970,lng:144.5983},
  {pref:"北海道",name:"別海町",date:46339,lat:43.3917,lng:145.1186},
  {pref:"北海道",name:"中標津町",date:46339,lat:43.5561,lng:144.9722},
  {pref:"北海道",name:"三笠市",date:46353,lat:43.2453,lng:141.8789},
  {pref:"北海道",name:"寿都町",date:46353,lat:42.7914,lng:140.2306},
  {pref:"北海道",name:"広尾町",date:46360,lat:42.2847,lng:143.3114},
  {pref:"北海道",name:"標津町",date:46367,lat:43.6611,lng:145.1317},
  {pref:"北海道",name:"羅臼町",date:46367,lat:44.0233,lng:145.1856},
  // Aomori
  {pref:"青森県",name:"つがる市",date:46373,lat:40.8072,lng:140.3822},
  {pref:"青森県",name:"鰺ヶ沢町",date:46374,lat:40.7803,lng:140.2092},
  {pref:"青森県",name:"深浦町",date:46374,lat:40.6464,lng:139.9275},
  {pref:"青森県",name:"鶴田町",date:46374,lat:40.7589,lng:140.4306},
  // Iwate
  {pref:"岩手県",name:"雫石町",date:46367,lat:39.6956,lng:140.9625},
  // Miyagi
  {pref:"宮城県",name:"七ヶ浜町",date:46338,lat:38.3017,lng:141.0536},
  {pref:"宮城県",name:"蔵王町",date:46381,lat:38.1003,lng:140.6553},
  // Akita
  {pref:"秋田県",name:"上小阿仁村",date:46381,lat:39.9428,lng:140.3378},
  // Fukushima
  {pref:"福島県",name:"浅川町",date:46338,lat:37.0733,lng:140.4119},
  // Niigata
  {pref:"新潟県",name:"粟島浦村",date:46360,lat:38.4519,lng:139.2444},
  // Ishikawa
  {pref:"石川県",name:"加賀市",date:46366,lat:36.3028,lng:136.3144},
  // Nagano
  {pref:"長野県",name:"坂城町",date:46367,lat:36.4636,lng:138.1808},
  // Aichi
  {pref:"愛知県",name:"幸田町",date:46339,lat:34.8608,lng:137.1633},
  // Mie
  {pref:"三重県",name:"多気町",date:46374,lat:34.4828,lng:136.5783},
  {pref:"三重県",name:"明和町",date:46374,lat:34.5444,lng:136.6278},
  {pref:"三重県",name:"大台町",date:46374,lat:34.3747,lng:136.4042},
  {pref:"三重県",name:"玉城町",date:46374,lat:34.4853,lng:136.6256},
  {pref:"三重県",name:"度会町",date:46374,lat:34.4019,lng:136.5906},
  {pref:"三重県",name:"大紀町",date:46374,lat:34.3131,lng:136.4000},
  {pref:"三重県",name:"松阪市",date:46380,lat:34.5781,lng:136.5308},
  {pref:"三重県",name:"鳥羽市",date:46380,lat:34.4811,lng:136.8431},
  // Tottori
  {pref:"鳥取県",name:"江府町",date:46346,lat:35.2722,lng:133.4878},
  {pref:"鳥取県",name:"大山町",date:46366,lat:35.3889,lng:133.5072},
  {pref:"鳥取県",name:"境港市",date:46380,lat:35.5392,lng:133.2317},
  {pref:"鳥取県",name:"琴浦町",date:46381,lat:35.4956,lng:133.6867},
  {pref:"鳥取県",name:"日南町",date:46381,lat:35.1414,lng:133.3000},
  // Okayama
  {pref:"岡山県",name:"和気町",date:46374,lat:34.7994,lng:134.1544},
  {pref:"岡山県",name:"西粟倉村",date:46374,lat:35.1775,lng:134.3350},
  {pref:"岡山県",name:"吉備中央町",date:46374,lat:34.8558,lng:133.6856},
  {pref:"岡山県",name:"浅口市",date:46380,lat:34.5250,lng:133.5833},
  // Hiroshima
  {pref:"広島県",name:"三次市",date:46359,lat:34.8019,lng:132.8508},
  {pref:"広島県",name:"坂町",date:46374,lat:34.3389,lng:132.5119},
  {pref:"広島県",name:"三原市",date:46379,lat:34.3978,lng:133.0781},
  // Yamaguchi
  {pref:"山口県",name:"萩市",date:46352,lat:34.4081,lng:131.3992},
  // Tokushima
  {pref:"徳島県",name:"北島町",date:46374,lat:34.1317,lng:134.5539},
  // Kagawa
  {pref:"香川県",name:"土庄町",date:46374,lat:34.4856,lng:134.1839},
  {pref:"香川県",name:"小豆島町",date:46374,lat:34.4644,lng:134.2508},
  // Ehime
  {pref:"愛媛県",name:"大洲市",date:46345,lat:33.5058,lng:132.5458},
  {pref:"愛媛県",name:"東温市",date:46345,lat:33.7878,lng:132.8678},
  {pref:"愛媛県",name:"久万高原町",date:46346,lat:33.6458,lng:132.9017},
  {pref:"愛媛県",name:"内子町",date:46346,lat:33.5319,lng:132.6544},
  {pref:"愛媛県",name:"八幡浜市",date:46352,lat:33.4608,lng:132.4236},
  // Kochi
  {pref:"高知県",name:"佐川町",date:46353,lat:33.5006,lng:133.2808},
  // Fukuoka
  {pref:"福岡県",name:"大牟田市",date:46345,lat:33.0303,lng:130.4461},
  {pref:"福岡県",name:"みやま市",date:46345,lat:33.1556,lng:130.4739},
  {pref:"福岡県",name:"飯塚市",date:46352,lat:33.6458,lng:130.6914},
  // Nagasaki
  {pref:"長崎県",name:"東彼杵町",date:46353,lat:33.0672,lng:129.9231},
  {pref:"長崎県",name:"川棚町",date:46353,lat:33.0744,lng:129.8656},
  {pref:"長崎県",name:"佐々町",date:46353,lat:33.2197,lng:129.6478},
  {pref:"長崎県",name:"波佐見町",date:46360,lat:33.1486,lng:129.8944},
  {pref:"長崎県",name:"新上五島町",date:46360,lat:32.9778,lng:129.0722},
  // Kumamoto
  {pref:"熊本県",name:"相良村",date:46283,lat:32.2719,lng:130.8092},
  {pref:"熊本県",name:"南阿蘇村",date:46339,lat:32.8522,lng:131.0383},
  {pref:"熊本県",name:"阿蘇市",date:46345,lat:32.9489,lng:131.1239},
  {pref:"熊本県",name:"西原村",date:46346,lat:32.8358,lng:130.9128},
  {pref:"熊本県",name:"上天草市",date:46352,lat:32.5778,lng:130.4378},
  {pref:"熊本県",name:"大津町",date:46353,lat:32.8764,lng:130.8686},
  {pref:"熊本県",name:"湯前町",date:46360,lat:32.2536,lng:131.0000},
  {pref:"熊本県",name:"山江村",date:46360,lat:32.2206,lng:130.8186},
  {pref:"熊本県",name:"球磨村",date:46360,lat:32.2728,lng:130.7103},
  {pref:"熊本県",name:"美里町",date:46374,lat:32.6158,lng:130.8194},
  // Kagoshima
  {pref:"鹿児島県",name:"指宿市",date:46282,lat:31.2519,lng:130.6319},
  {pref:"鹿児島県",name:"肝付町",date:46360,lat:31.1858,lng:130.9875},
  {pref:"鹿児島県",name:"長島町",date:46374,lat:32.2003,lng:130.1683},
  {pref:"鹿児島県",name:"天城町",date:46374,lat:27.3906,lng:128.8819},
  // Okinawa
  {pref:"沖縄県",name:"沖縄市",date:46352,lat:26.3342,lng:127.8056}
];

// Convert Excel serial to date string
function excelDateToString(serial) {
  const epoch = new Date(1899, 11, 30);
  const d = new Date(epoch.getTime() + serial * 86400000);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return y + '年' + m + '月' + day + '日';
}

// Prefecture colors
const prefColors = {};
const colorPalette = [
  '#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd',
  '#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf',
  '#393b79','#637939','#8c6d31','#843c39','#7b4173',
  '#5254a3','#6b6ecf','#9c9ede','#31a354','#756bb1',
  '#636363','#e6550d','#3182bd','#e7969c','#c7e9c0'
];

const prefList = [...new Set(municipalities.map(m => m.pref))];
prefList.forEach((p, i) => {
  prefColors[p] = colorPalette[i % colorPalette.length];
});

// Calculate density (number of neighbors within 50km)
function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
    Math.sin(dLng/2) * Math.sin(dLng/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

municipalities.forEach((m, i) => {
  const neighborList = [];
  municipalities.forEach((n, j) => {
    if (i !== j && haversine(m.lat, m.lng, n.lat, n.lng) < 50) {
      neighborList.push(n.name);
    }
  });
  m.neighbors = neighborList.length;
  m.neighborNames = neighborList;
  if (neighborList.length >= 3) {
    m.density = 'dense';
    m.densityColor = '#d32f2f';
    m.densityLabel = '密集';
  } else {
    m.density = 'sparse';
    m.densityColor = '#2196F3';
    m.densityLabel = '非密集';
  }
  m.dateStr = excelDateToString(m.date);
});

// Map
const map = L.map('map', {
  zoomControl: true
}).setView([36.5, 137.0], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors',
  maxZoom: 18
}).addTo(map);

// Create markers
const markers = {};
const markerGroup = L.featureGroup();

municipalities.forEach(m => {
  const markerColor = m.densityColor;
  const prefColor = prefColors[m.pref];

  const icon = L.divIcon({
    className: 'custom-marker',
    html: `<div style="
      width: 24px; height: 24px;
      background: ${markerColor};
      border: 3px solid ${prefColor};
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.35);
      transition: transform 0.2s;
    " onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform='scale(1)'"></div>`,
    iconSize: [24, 24],
    iconAnchor: [12, 12],
    popupAnchor: [0, -14]
  });

  const marker = L.marker([m.lat, m.lng], { icon: icon });

  const neighborSection = m.neighbors > 0
    ? `<div class="neighbor-info">
        <div class="neighbor-label">隣接市町村（50km以内）: <strong>${m.neighbors}件</strong></div>
        <div class="neighbor-list">${m.neighborNames.join('、')}</div>
      </div>`
    : `<div class="neighbor-info"><div class="neighbor-label">隣接市町村（50km以内）: <strong>なし</strong></div></div>`;

  const popupContent = `
    <div class="popup-content">
      <h3>${m.name}</h3>
      <div class="pref-name">${m.pref}</div>
      <div class="date-info">
        <div class="date-label">利用開始日</div>
        <div class="date-value">${m.dateStr}</div>
      </div>
      <div class="density-badge" style="background:${m.densityColor}">
        ${m.densityLabel}（隣接 ${m.neighbors} 市町村）
      </div>
      ${neighborSection}
    </div>
  `;

  marker.bindPopup(popupContent, { className: 'custom-popup', maxWidth: 320 });
  marker.addTo(map);
  markerGroup.addLayer(marker);

  const key = m.pref + '_' + m.name;
  markers[key] = { marker, data: m };
});

// Stats
document.getElementById('stats').innerHTML =
  `全 <strong>${municipalities.length}</strong> 市町村 / <strong>${prefList.length}</strong> 都道府県`;

// Prefecture legend
const prefLegendEl = document.getElementById('prefLegend');
prefList.forEach(pref => {
  const count = municipalities.filter(m => m.pref === pref).length;
  const item = document.createElement('div');
  item.className = 'legend-item';
  item.innerHTML = `<div class="legend-color" style="background:${prefColors[pref]}"></div>${pref} (${count})`;
  item.addEventListener('click', () => {
    const prefMunis = municipalities.filter(m => m.pref === pref);
    const bounds = L.latLngBounds(prefMunis.map(m => [m.lat, m.lng]));
    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 10 });
  });
  prefLegendEl.appendChild(item);
});

// Municipality list
function renderMuniList(filter = '') {
  const listEl = document.getElementById('muniList');
  listEl.innerHTML = '';
  const filtered = municipalities.filter(m =>
    m.name.includes(filter) || m.pref.includes(filter)
  );
  filtered.forEach(m => {
    const item = document.createElement('div');
    item.className = 'muni-item';
    item.innerHTML = `<span class="pref">${m.pref}</span> <strong>${m.name}</strong>`;
    item.addEventListener('click', () => {
      map.setView([m.lat, m.lng], 12);
      const key = m.pref + '_' + m.name;
      if (markers[key]) {
        markers[key].marker.openPopup();
      }
    });
    listEl.appendChild(item);
  });
}

renderMuniList();

document.getElementById('searchBox').addEventListener('input', (e) => {
  renderMuniList(e.target.value);
});

// Draw proximity lines for nearby municipalities
function drawProximityLines() {
  const lineGroup = L.layerGroup();
  const drawn = new Set();

  municipalities.forEach((m, i) => {
    municipalities.forEach((n, j) => {
      if (i >= j) return;
      const dist = haversine(m.lat, m.lng, n.lat, n.lng);
      if (dist < 30) {
        const key = i + '-' + j;
        if (!drawn.has(key)) {
          drawn.add(key);
          const opacity = Math.max(0.1, 1 - dist / 30);
          L.polyline([[m.lat, m.lng], [n.lat, n.lng]], {
            color: '#d32f2f',
            weight: 1.5,
            opacity: opacity,
            dashArray: '4 4'
          }).addTo(lineGroup);
        }
      }
    });
  });

  lineGroup.addTo(map);

  map.on('zoomend', () => {
    if (map.getZoom() >= 8) {
      lineGroup.addTo(map);
    } else {
      map.removeLayer(lineGroup);
    }
  });

  if (map.getZoom() < 8) {
    map.removeLayer(lineGroup);
  }
}

drawProximityLines();
</script>
</body>
</html>
