<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R8年 標準化予定 市町村マップ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif; }
#map { width: 100%; height: 100vh; }
#loading {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.92); z-index: 9999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  font-size: 16px; color: #333;
}
.spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: #2196F3; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
@keyframes spin { to { transform: rotate(360deg); } }

.sidebar {
  position: absolute; top: 10px; right: 10px; z-index: 1000;
  background: white; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.2);
  padding: 12px; max-height: calc(100vh - 20px); overflow-y: auto; width: 320px; font-size: 13px;
}
.sidebar h2 { font-size: 15px; margin-bottom: 8px; border-bottom: 2px solid #333; padding-bottom: 6px; }
.sidebar .stats { margin-bottom: 10px; color: #555; font-size: 12px; }

.sidebar-toggle-btn {
  position: absolute; top: 10px; right: 10px; z-index: 1001;
  background: white; border: none; border-radius: 50%; width: 36px; height: 36px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.25); cursor: pointer; font-size: 18px;
  display: flex; align-items: center; justify-content: center; color: #333; transition: all 0.3s;
}
.sidebar-toggle-btn:hover { background: #f0f0f0; transform: scale(1.1); }
.sidebar.collapsed { width: auto; padding: 8px; max-height: none; overflow: visible; }
.sidebar.collapsed .sidebar-content { display: none; }
.sidebar.collapsed h2 { display: none; }
.sidebar.collapsed .stats { display: none; }

.collapsible-header {
  cursor: pointer; user-select: none; display: flex; align-items: center; justify-content: space-between;
  padding: 4px 0; margin-bottom: 4px;
}
.collapsible-header:hover { opacity: 0.7; }
.collapsible-header .toggle-icon {
  font-size: 11px; color: #888; transition: transform 0.2s; flex-shrink: 0; margin-left: 6px;
}
.collapsible-header.closed .toggle-icon { transform: rotate(-90deg); }
.collapsible-body { overflow: hidden; transition: max-height 0.3s ease; }
.collapsible-body.closed { max-height: 0 !important; overflow: hidden; }

.legend-section { margin-bottom: 10px; }
.legend-section h3 { font-size: 13px; margin-bottom: 0; color: #333; }
.search-box { width: 100%; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 8px; font-size: 13px; }
.search-box:focus { outline: none; border-color: #4A90D9; }

.municipality-list { max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
.muni-item { display: flex; align-items: center; padding: 4px 6px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 12px; transition: background 0.15s; gap: 4px; }
.muni-item:hover { background: #e8f0fe; }
.muni-item .pref { color: #888; font-size: 10px; }
.muni-item input[type="checkbox"] { margin-right: 4px; flex-shrink: 0; cursor: pointer; }
.muni-item .pop-badge { font-size: 10px; color: #888; margin-left: auto; white-space: nowrap; }

.check-all-bar { display: flex; gap: 8px; margin-bottom: 4px; }
.check-all-bar button { font-size: 11px; padding: 2px 8px; border: 1px solid #ccc; border-radius: 4px; background: #f5f5f5; cursor: pointer; }
.check-all-bar button:hover { background: #e0e0e0; }

.cluster-info-box { margin-top: 8px; padding: 8px; background: #f0f4ff; border-radius: 6px; border: 1px solid #c5cae9; font-size: 11px; }
.cluster-info-box h4 { font-size: 12px; margin-bottom: 4px; color: #1a237e; }
.cluster-row { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid #e0e0e0; }
.cluster-row:last-child { border-bottom: none; }

.custom-popup .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 3px 14px rgba(0,0,0,0.25); }
.popup-content { font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif; min-width: 200px; }
.popup-content h3 { font-size: 16px; margin-bottom: 4px; color: #1a1a1a; }
.popup-content .pref-name { font-size: 12px; color: #666; margin-bottom: 8px; }
.popup-content .date-info { background: #f5f7fa; padding: 6px 10px; border-radius: 4px; font-size: 13px; margin-bottom: 4px; }
.popup-content .date-label { font-size: 11px; color: #888; }
.popup-content .date-value { font-size: 15px; font-weight: bold; color: #2c5aa0; }
.popup-content .pop-info { background: #f5f5f5; padding: 6px 10px; border-radius: 4px; font-size: 13px; margin-bottom: 4px; }
.popup-content .pop-label { font-size: 11px; color: #888; }
.popup-content .pop-value { font-size: 15px; font-weight: bold; color: #333; }
.density-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-top: 6px; color: white; font-weight: bold; }
.neighbor-info { margin-top: 8px; padding: 6px 10px; background: #f9f9f9; border-radius: 4px; border-left: 3px solid #999; }
.neighbor-label { font-size: 11px; color: #555; margin-bottom: 3px; }
.neighbor-list { font-size: 12px; color: #333; line-height: 1.5; }
.cluster-pop-info { margin-top: 6px; padding: 6px 10px; background: #e8f5e9; border-radius: 4px; border-left: 3px solid #4caf50; font-size: 12px; }

.info-box { position: absolute; bottom: 20px; left: 10px; z-index: 1000; background: white; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.2); padding: 10px 14px; font-size: 12px; color: #555; }
.info-box strong { color: #333; }

.density-legend { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
.density-legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; }
.density-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.15); }
.density-definition { margin-bottom: 8px; }
.def-box { background: #fff8e1; border: 1px solid #ffe082; border-radius: 6px; padding: 8px 10px; margin-top: 4px; }
.def-title { font-size: 12px; font-weight: bold; color: #e65100; margin-bottom: 4px; }
.def-body { font-size: 11px; color: #555; line-height: 1.6; }
.map-note { margin-top: 6px; font-size: 10px; color: #999; line-height: 1.5; }

.pop-gradient { display: flex; align-items: center; gap: 4px; margin-top: 6px; font-size: 10px; color: #666; }
.pop-gradient-bar { flex: 1; height: 12px; border-radius: 3px; border: 1px solid #ccc; }
.pop-gradient-bar.dense { background: linear-gradient(to right, #ffcdd2, #b71c1c); }
.pop-gradient-bar.sparse { background: linear-gradient(to right, #bbdefb, #0d47a1); }
</style>
</head>
<body>
<div id="loading"><div class="spinner"></div>市町村境界データを読み込み中...</div>
<div id="map"></div>

<button class="sidebar-toggle-btn" id="sidebarToggle" title="凡例を表示/非表示">☰</button>
<div class="sidebar" id="sidebar">
  <h2>R8年 標準化予定市町村</h2>
  <div class="stats" id="stats"></div>
  <div class="sidebar-content">
  <input type="text" class="search-box" id="searchBox" placeholder="市町村名で検索...">

  <div class="legend-section">
    <div class="collapsible-header" data-target="legendBody">
      <h3>密集度 × 人口規模による色分け</h3>
      <span class="toggle-icon">▼</span>
    </div>
    <div class="collapsible-body" id="legendBody">
      <div class="density-definition">
        <div class="def-box">
          <div class="def-title">「密集」の定義</div>
          <div class="def-body">
            チェックされた市町村の行政区域で<br>
            <strong>実際に境界を共有する</strong>市町村同士を<br>
            「隣接」としてグラフ化し、<strong>連なり<br>
            （クラスター）が3市町村以上</strong>で<br>
            あれば「密集」と判定。<br>
            人口が多いほど色が<strong>濃く</strong>なります。
          </div>
        </div>
      </div>
      <div class="density-legend">
        <div class="density-legend-item"><div class="density-dot" style="background:#d32f2f"></div><strong>密集</strong></div>
        <div class="density-legend-item"><div class="density-dot" style="background:#2196F3"></div><strong>非密集</strong></div>
      </div>
      <div style="margin-top:4px">
        <div class="pop-gradient">少<div class="pop-gradient-bar dense"></div>多 <span style="color:#d32f2f">密集</span></div>
        <div class="pop-gradient">少<div class="pop-gradient-bar sparse"></div>多 <span style="color:#2196F3">非密集</span></div>
      </div>
      <div class="map-note">
        ※ 人口: 2020年国勢調査<br>
        ※ 市町村境界: 国土数値情報（国土交通省）
      </div>
    </div>
  </div>

  <div class="legend-section">
    <div class="collapsible-header" data-target="clusterBody">
      <h3>密集クラスター情報</h3>
      <span class="toggle-icon">▼</span>
    </div>
    <div class="collapsible-body" id="clusterBody">
      <div id="clusterInfoArea"></div>
    </div>
  </div>

  <div class="legend-section">
    <div class="collapsible-header" data-target="muniBody">
      <h3>市町村一覧（チェックで表示切替）</h3>
      <span class="toggle-icon">▼</span>
    </div>
    <div class="collapsible-body" id="muniBody">
      <div class="check-all-bar">
        <button id="btnCheckAll">全選択</button>
        <button id="btnUncheckAll">全解除</button>
      </div>
      <div class="municipality-list" id="muniList"></div>
    </div>
  </div>
  </div>
</div>

<div class="info-box">
  <strong>操作方法:</strong> 色付きの市町村をクリックで詳細表示 / チェックで表示ON/OFF
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
<script>
// Population data (2020 Census)
var popData = {"安平町":7340,"えりも町":4374,"美瑛町":9668,"新得町":5817,"更別村":3080,"浜中町":5507,"標茶町":7230,"別海町":14380,"中標津町":23010,"三笠市":8040,"寿都町":2838,"広尾町":6387,"標津町":5023,"羅臼町":4722,"つがる市":30934,"鰺ヶ沢町":9044,"深浦町":7346,"鶴田町":12074,"雫石町":15731,"七ヶ浜町":18132,"蔵王町":11418,"上小阿仁村":2063,"浅川町":6036,"粟島浦村":353,"加賀市":63220,"坂城町":14004,"幸田町":42449,"多気町":14021,"明和町":22445,"大台町":8668,"玉城町":15041,"度会町":7847,"大紀町":7815,"松阪市":159145,"鳥羽市":17525,"江府町":2672,"大山町":15370,"境港市":32740,"琴浦町":16365,"日南町":4196,"和気町":13623,"西粟倉村":1398,"吉備中央町":10886,"浅口市":32772,"三次市":50681,"坂町":12582,"三原市":90573,"萩市":44626,"北島町":22745,"土庄町":12846,"小豆島町":13870,"大洲市":40575,"東温市":33903,"久万高原町":7404,"内子町":15322,"八幡浜市":31987,"佐川町":12323,"大牟田市":111281,"みやま市":35861,"飯塚市":126364,"東彼杵町":7721,"川棚町":13377,"佐々町":13912,"波佐見町":14291,"新上五島町":17503,"相良村":4070,"南阿蘇村":9836,"阿蘇市":24930,"西原村":6426,"上天草市":24563,"大津町":35187,"湯前町":3627,"山江村":3238,"球磨村":2433,"美里町":9392,"指宿市":39011,"肝付町":14227,"長島町":9705,"天城町":5517,"沖縄市":142752};
var popMin = Math.min.apply(null, Object.values(popData));
var popMax = Math.max.apply(null, Object.values(popData));

function popToRatio(pop) {
  // log scale for better visual spread
  var logMin = Math.log(popMin || 1);
  var logMax = Math.log(popMax);
  return (Math.log(pop || 1) - logMin) / (logMax - logMin);
}

function getDenseColor(ratio) {
  // light red -> dark red
  var r = Math.round(255 - ratio * 72);
  var g = Math.round(205 - ratio * 177);
  var b = Math.round(210 - ratio * 183);
  return 'rgb(' + r + ',' + g + ',' + b + ')';
}
function getSparseColor(ratio) {
  // light blue -> dark blue
  var r = Math.round(187 - ratio * 174);
  var g = Math.round(222 - ratio * 151);
  var b = Math.round(251 - ratio * 90);
  return 'rgb(' + r + ',' + g + ',' + b + ')';
}

function formatPop(n) {
  return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// Data
var municipalities = [
  {pref:"北海道",name:"安平町",date:46339,lat:42.7631,lng:141.8233},
  {pref:"北海道",name:"えりも町",date:46339,lat:42.0142,lng:143.1461},
  {pref:"北海道",name:"美瑛町",date:46339,lat:43.5873,lng:142.4685},
  {pref:"北海道",name:"新得町",date:46339,lat:43.0792,lng:142.8386},
  {pref:"北海道",name:"更別村",date:46339,lat:42.7297,lng:143.1997},
  {pref:"北海道",name:"浜中町",date:46339,lat:43.0756,lng:145.1247},
  {pref:"北海道",name:"標茶町",date:46339,lat:43.2970,lng:144.5983},
  {pref:"北海道",name:"別海町",date:46339,lat:43.3917,lng:145.1186},
  {pref:"北海道",name:"中標津町",date:46339,lat:43.5561,lng:144.9722},
  {pref:"北海道",name:"三笠市",date:46353,lat:43.2453,lng:141.8789},
  {pref:"北海道",name:"寿都町",date:46353,lat:42.7914,lng:140.2306},
  {pref:"北海道",name:"広尾町",date:46360,lat:42.2847,lng:143.3114},
  {pref:"北海道",name:"標津町",date:46367,lat:43.6611,lng:145.1317},
  {pref:"北海道",name:"羅臼町",date:46367,lat:44.0233,lng:145.1856},
  {pref:"青森県",name:"つがる市",date:46373,lat:40.8072,lng:140.3822},
  {pref:"青森県",name:"鰺ヶ沢町",date:46374,lat:40.7803,lng:140.2092},
  {pref:"青森県",name:"深浦町",date:46374,lat:40.6464,lng:139.9275},
  {pref:"青森県",name:"鶴田町",date:46374,lat:40.7589,lng:140.4306},
  {pref:"岩手県",name:"雫石町",date:46367,lat:39.6956,lng:140.9625},
  {pref:"宮城県",name:"七ヶ浜町",date:46338,lat:38.3017,lng:141.0536},
  {pref:"宮城県",name:"蔵王町",date:46381,lat:38.1003,lng:140.6553},
  {pref:"秋田県",name:"上小阿仁村",date:46381,lat:39.9428,lng:140.3378},
  {pref:"福島県",name:"浅川町",date:46338,lat:37.0733,lng:140.4119},
  {pref:"新潟県",name:"粟島浦村",date:46360,lat:38.4519,lng:139.2444},
  {pref:"石川県",name:"加賀市",date:46366,lat:36.3028,lng:136.3144},
  {pref:"長野県",name:"坂城町",date:46367,lat:36.4636,lng:138.1808},
  {pref:"愛知県",name:"幸田町",date:46339,lat:34.8608,lng:137.1633},
  {pref:"三重県",name:"多気町",date:46374,lat:34.4828,lng:136.5783},
  {pref:"三重県",name:"明和町",date:46374,lat:34.5444,lng:136.6278},
  {pref:"三重県",name:"大台町",date:46374,lat:34.3747,lng:136.4042},
  {pref:"三重県",name:"玉城町",date:46374,lat:34.4853,lng:136.6256},
  {pref:"三重県",name:"度会町",date:46374,lat:34.4019,lng:136.5906},
  {pref:"三重県",name:"大紀町",date:46374,lat:34.3131,lng:136.4000},
  {pref:"三重県",name:"松阪市",date:46380,lat:34.5781,lng:136.5308},
  {pref:"三重県",name:"鳥羽市",date:46380,lat:34.4811,lng:136.8431},
  {pref:"鳥取県",name:"江府町",date:46346,lat:35.2722,lng:133.4878},
  {pref:"鳥取県",name:"大山町",date:46366,lat:35.3889,lng:133.5072},
  {pref:"鳥取県",name:"境港市",date:46380,lat:35.5392,lng:133.2317},
  {pref:"鳥取県",name:"琴浦町",date:46381,lat:35.4956,lng:133.6867},
  {pref:"鳥取県",name:"日南町",date:46381,lat:35.1414,lng:133.3000},
  {pref:"岡山県",name:"和気町",date:46374,lat:34.7994,lng:134.1544},
  {pref:"岡山県",name:"西粟倉村",date:46374,lat:35.1775,lng:134.3350},
  {pref:"岡山県",name:"吉備中央町",date:46374,lat:34.8558,lng:133.6856},
  {pref:"岡山県",name:"浅口市",date:46380,lat:34.5250,lng:133.5833},
  {pref:"広島県",name:"三次市",date:46359,lat:34.8019,lng:132.8508},
  {pref:"広島県",name:"坂町",date:46374,lat:34.3389,lng:132.5119},
  {pref:"広島県",name:"三原市",date:46379,lat:34.3978,lng:133.0781},
  {pref:"山口県",name:"萩市",date:46352,lat:34.4081,lng:131.3992},
  {pref:"徳島県",name:"北島町",date:46374,lat:34.1317,lng:134.5539},
  {pref:"香川県",name:"土庄町",date:46374,lat:34.4856,lng:134.1839},
  {pref:"香川県",name:"小豆島町",date:46374,lat:34.4644,lng:134.2508},
  {pref:"愛媛県",name:"大洲市",date:46345,lat:33.5058,lng:132.5458},
  {pref:"愛媛県",name:"東温市",date:46345,lat:33.7878,lng:132.8678},
  {pref:"愛媛県",name:"久万高原町",date:46346,lat:33.6458,lng:132.9017},
  {pref:"愛媛県",name:"内子町",date:46346,lat:33.5319,lng:132.6544},
  {pref:"愛媛県",name:"八幡浜市",date:46352,lat:33.4608,lng:132.4236},
  {pref:"高知県",name:"佐川町",date:46353,lat:33.5006,lng:133.2808},
  {pref:"福岡県",name:"大牟田市",date:46345,lat:33.0303,lng:130.4461},
  {pref:"福岡県",name:"みやま市",date:46345,lat:33.1556,lng:130.4739},
  {pref:"福岡県",name:"飯塚市",date:46352,lat:33.6458,lng:130.6914},
  {pref:"長崎県",name:"東彼杵町",date:46353,lat:33.0672,lng:129.9231},
  {pref:"長崎県",name:"川棚町",date:46353,lat:33.0744,lng:129.8656},
  {pref:"長崎県",name:"佐々町",date:46353,lat:33.2197,lng:129.6478},
  {pref:"長崎県",name:"波佐見町",date:46360,lat:33.1486,lng:129.8944},
  {pref:"長崎県",name:"新上五島町",date:46360,lat:32.9778,lng:129.0722},
  {pref:"熊本県",name:"相良村",date:46283,lat:32.2719,lng:130.8092},
  {pref:"熊本県",name:"南阿蘇村",date:46339,lat:32.8522,lng:131.0383},
  {pref:"熊本県",name:"阿蘇市",date:46345,lat:32.9489,lng:131.1239},
  {pref:"熊本県",name:"西原村",date:46346,lat:32.8358,lng:130.9128},
  {pref:"熊本県",name:"上天草市",date:46352,lat:32.5778,lng:130.4378},
  {pref:"熊本県",name:"大津町",date:46353,lat:32.8764,lng:130.8686},
  {pref:"熊本県",name:"湯前町",date:46360,lat:32.2536,lng:131.0000},
  {pref:"熊本県",name:"山江村",date:46360,lat:32.2206,lng:130.8186},
  {pref:"熊本県",name:"球磨村",date:46360,lat:32.2728,lng:130.7103},
  {pref:"熊本県",name:"美里町",date:46374,lat:32.6158,lng:130.8194},
  {pref:"鹿児島県",name:"指宿市",date:46282,lat:31.2519,lng:130.6319},
  {pref:"鹿児島県",name:"肝付町",date:46360,lat:31.1858,lng:130.9875},
  {pref:"鹿児島県",name:"長島町",date:46374,lat:32.2003,lng:130.1683},
  {pref:"鹿児島県",name:"天城町",date:46374,lat:27.3906,lng:128.8819},
  {pref:"沖縄県",name:"沖縄市",date:46352,lat:26.3342,lng:127.8056}
];

function excelDateToString(serial) {
  var epoch = new Date(1899, 11, 30);
  var d = new Date(epoch.getTime() + serial * 86400000);
  return d.getFullYear() + '年' + String(d.getMonth()+1).padStart(2,'0') + '月' + String(d.getDate()).padStart(2,'0') + '日';
}

municipalities.forEach(function(m) {
  m.pop = popData[m.name] || 0;
  m.dateStr = excelDateToString(m.date);
  m.enabled = true; // checkbox state
});

var muniLookup = {};
municipalities.forEach(function(m) {
  muniLookup[m.name] = m;
  muniLookup[m.pref + '_' + m.name] = m;
});

// Map
var map = L.map('map', { zoomControl: true }).setView([36.5, 137.0], 6);

var gsiPale = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
  attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>', maxZoom: 18
});
var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors', maxZoom: 18
});
var gsiStd = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
  attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>', maxZoom: 18
});
gsiPale.addTo(map);
L.control.layers({'国土地理院 淡色地図': gsiPale, '国土地理院 標準地図': gsiStd, 'OpenStreetMap': osm}, null, {position:'topleft'}).addTo(map);

// Globals set after TopoJSON load
var polygonLayers = {}; // key -> [layer, ...]
var topoNeighbors = null;
var featureToMuni = null;
var geometries = null;
var geoLayer = null;

// ---- Core: recompute clusters for enabled municipalities and redraw ----
function recompute() {
  var enabled = municipalities.filter(function(m){ return m.enabled; });
  var enabledKeys = new Set(enabled.map(function(m){ return m.pref+'_'+m.name; }));

  // Build adjacency only among enabled munis using real boundary data
  var adj = {};
  enabled.forEach(function(m){ adj[m.pref+'_'+m.name] = new Set(); });

  if (geometries && topoNeighbors && featureToMuni) {
    geometries.forEach(function(geom, fi) {
      var mA = featureToMuni[fi];
      if (!mA || !mA.enabled) return;
      var kA = mA.pref+'_'+mA.name;
      (topoNeighbors[fi]||[]).forEach(function(ni) {
        var mB = featureToMuni[ni];
        if (!mB || !mB.enabled) return;
        var kB = mB.pref+'_'+mB.name;
        if (kA !== kB) { adj[kA].add(kB); adj[kB].add(kA); }
      });
    });
  }

  // Store neighbor names
  enabled.forEach(function(m) {
    var k = m.pref+'_'+m.name;
    var s = adj[k] || new Set();
    m.neighborNames = Array.from(s).map(function(x){ return x.split('_').slice(1).join('_'); });
    m.neighbors = m.neighborNames.length;
  });

  // BFS clusters
  var vis = {};
  var clusters = [];
  enabled.forEach(function(m) {
    var k = m.pref+'_'+m.name;
    if (vis[k]) return;
    var queue = [k], cluster = [];
    vis[k] = true;
    while (queue.length) {
      var cur = queue.shift();
      cluster.push(cur);
      (adj[cur]||new Set()).forEach(function(nb) {
        if (!vis[nb]) { vis[nb]=true; queue.push(nb); }
      });
    }
    clusters.push(cluster);
  });

  // Assign density + cluster info
  clusters.forEach(function(cluster) {
    var isDense = cluster.length >= 3;
    var totalPop = 0;
    cluster.forEach(function(k) {
      var m = muniLookup[k];
      if (m) totalPop += m.pop;
    });
    cluster.forEach(function(k) {
      var m = muniLookup[k];
      if (!m) return;
      m.density = isDense ? 'dense' : 'sparse';
      m.densityLabel = isDense ? '密集' : '非密集';
      m.clusterSize = cluster.length;
      m.clusterMembers = cluster.map(function(x){ return x.split('_').slice(1).join('_'); });
      m.clusterPop = totalPop;
      var ratio = popToRatio(m.pop);
      m.densityColor = isDense ? getDenseColor(ratio) : getSparseColor(ratio);
    });
  });

  // Disabled munis reset
  municipalities.forEach(function(m) {
    if (!m.enabled) {
      m.density = 'none';
      m.densityColor = '#ccc';
      m.densityLabel = '除外';
      m.clusterSize = 0;
      m.clusterMembers = [];
      m.clusterPop = 0;
      m.neighborNames = [];
      m.neighbors = 0;
    }
  });

  // Update polygon styles
  municipalities.forEach(function(m) {
    var k = m.pref+'_'+m.name;
    var layers = polygonLayers[k];
    if (!layers) return;
    layers.forEach(function(layer) {
      if (m.enabled) {
        layer.setStyle({ fillColor: m.densityColor, fillOpacity: 0.6, color: '#333', weight: 2, opacity: 0.8 });
        // Rebind popup
        layer.unbindPopup();
        layer.bindPopup(buildPopup(m), { className:'custom-popup', maxWidth:340 });
      } else {
        layer.setStyle({ fillOpacity: 0, weight: 0, opacity: 0 });
        layer.unbindPopup();
      }
    });
  });

  // Update cluster info box
  renderClusterInfo(clusters);
}

function buildPopup(m) {
  var clusterSection = m.clusterSize > 1
    ? '<div class="neighbor-info"><div class="neighbor-label">所属クラスター: <strong>' + m.clusterSize + '市町村</strong></div>' +
      '<div class="neighbor-list">' + m.clusterMembers.filter(function(n){return n!==m.name}).join('、') + '</div></div>'
    : '<div class="neighbor-info"><div class="neighbor-label">所属クラスター: <strong>単独</strong></div></div>';
  var neighborSection = m.neighbors > 0
    ? '<div class="neighbor-info"><div class="neighbor-label">境界を共有する隣接: <strong>' + m.neighbors + '件</strong></div>' +
      '<div class="neighbor-list">' + m.neighborNames.join('、') + '</div></div>'
    : '';
  var clusterPopSection = m.clusterPop > 0
    ? '<div class="cluster-pop-info">クラスター合計人口: <strong>' + formatPop(m.clusterPop) + '人</strong></div>'
    : '';
  return '<div class="popup-content">' +
    '<h3>' + m.name + '</h3><div class="pref-name">' + m.pref + '</div>' +
    '<div class="pop-info"><div class="pop-label">人口（2020年国勢調査）</div><div class="pop-value">' + formatPop(m.pop) + ' 人</div></div>' +
    '<div class="date-info"><div class="date-label">利用開始日</div><div class="date-value">' + m.dateStr + '</div></div>' +
    '<div class="density-badge" style="background:' + m.densityColor + '">' + m.densityLabel + '（クラスター ' + m.clusterSize + ' 市町村）</div>' +
    clusterSection + neighborSection + clusterPopSection + '</div>';
}

function renderClusterInfo(clusters) {
  var area = document.getElementById('clusterInfoArea');
  var dense = clusters.filter(function(c){ return c.length >= 3; });
  if (dense.length === 0) { area.innerHTML = '<div class="cluster-info-box"><h4>密集クラスター</h4><div style="color:#888">なし</div></div>'; return; }
  var html = '<div class="cluster-info-box"><h4>密集クラスター一覧</h4>';
  dense.forEach(function(cluster, ci) {
    var totalPop = 0;
    var names = [];
    cluster.forEach(function(k) {
      var m = muniLookup[k];
      if (m) { totalPop += m.pop; names.push(m.name); }
    });
    html += '<div class="cluster-row"><div><strong>C' + (ci+1) + '</strong> (' + cluster.length + '市町村): ' + names.join(', ') + '</div></div>';
    html += '<div class="cluster-row" style="color:#4caf50;font-weight:bold">合計人口: ' + formatPop(totalPop) + '人</div>';
  });
  html += '</div>';
  area.innerHTML = html;
}

// ---- Render municipality list with checkboxes ----
function renderMuniList(filter) {
  filter = filter || '';
  var listEl = document.getElementById('muniList');
  listEl.innerHTML = '';
  var filtered = municipalities.filter(function(m) {
    return m.name.indexOf(filter) !== -1 || m.pref.indexOf(filter) !== -1;
  });
  filtered.forEach(function(m) {
    var item = document.createElement('div');
    item.className = 'muni-item';
    var cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = m.enabled;
    cb.addEventListener('change', function() {
      m.enabled = this.checked;
      recompute();
    });
    var label = document.createElement('span');
    label.innerHTML = '<span class="pref">' + m.pref + '</span> <strong>' + m.name + '</strong>';
    label.style.cursor = 'pointer';
    label.addEventListener('click', function() {
      var k = m.pref+'_'+m.name;
      if (polygonLayers[k] && polygonLayers[k].length && m.enabled) {
        var group = L.featureGroup(polygonLayers[k]);
        map.fitBounds(group.getBounds(), {padding:[50,50], maxZoom:12});
        polygonLayers[k][0].openPopup();
      } else {
        map.setView([m.lat, m.lng], 12);
      }
    });
    var popBadge = document.createElement('span');
    popBadge.className = 'pop-badge';
    popBadge.textContent = formatPop(m.pop) + '人';
    item.appendChild(cb);
    item.appendChild(label);
    item.appendChild(popBadge);
    listEl.appendChild(item);
  });
}

document.getElementById('searchBox').addEventListener('input', function(e) { renderMuniList(e.target.value); });
document.getElementById('btnCheckAll').addEventListener('click', function() {
  municipalities.forEach(function(m){ m.enabled = true; });
  renderMuniList(document.getElementById('searchBox').value);
  recompute();
});
document.getElementById('btnUncheckAll').addEventListener('click', function() {
  municipalities.forEach(function(m){ m.enabled = false; });
  renderMuniList(document.getElementById('searchBox').value);
  recompute();
});

// Stats
document.getElementById('stats').innerHTML = '全 <strong>' + municipalities.length + '</strong> 市町村';

// ---- Load TopoJSON ----
var TOPOJSON_URL = 'https://cdn.jsdelivr.net/gh/smartnews-smri/japan-topography@main/data/municipality/topojson/s0010/N03-21_210101.json';

fetch(TOPOJSON_URL).then(function(res){ return res.json(); }).then(function(topo) {
  var objectKey = Object.keys(topo.objects)[0];
  geometries = topo.objects[objectKey].geometries;
  var geojson = topojson.feature(topo, topo.objects[objectKey]);
  topoNeighbors = topojson.neighbors(geometries);

  featureToMuni = new Array(geometries.length).fill(null);
  geometries.forEach(function(geom, fi) {
    var props = geom.properties;
    var cityName = props.N03_003 || '', townName = props.N03_004 || '', prefName = props.N03_001 || '';
    var matched = null;
    if (townName && muniLookup[townName]) { var c = muniLookup[townName]; if (c.pref === prefName) matched = c; }
    if (!matched && cityName && muniLookup[cityName]) { var c2 = muniLookup[cityName]; if (c2.pref === prefName) matched = c2; }
    featureToMuni[fi] = matched;
  });

  geoLayer = L.geoJSON(geojson, {
    style: function() { return { fillOpacity: 0, weight: 0, opacity: 0 }; },
    onEachFeature: function(feature, layer) {
      var props = feature.properties;
      var cityName = props.N03_003 || '', townName = props.N03_004 || '', prefName = props.N03_001 || '';
      var matched = null;
      if (townName && muniLookup[townName]) { var c = muniLookup[townName]; if (c.pref === prefName) matched = c; }
      if (!matched && cityName && muniLookup[cityName]) { var c2 = muniLookup[cityName]; if (c2.pref === prefName) matched = c2; }
      if (!matched) return;

      layer.on('mouseover', function() { if (matched.enabled) { this.setStyle({ fillOpacity: 0.85, weight: 3 }); this.bringToFront(); }});
      layer.on('mouseout', function() { if (matched.enabled) { this.setStyle({ fillOpacity: 0.6, weight: 2 }); }});

      var key = matched.pref + '_' + matched.name;
      if (!polygonLayers[key]) polygonLayers[key] = [];
      polygonLayers[key].push(layer);
    }
  }).addTo(map);

  // Initial compute
  recompute();
  renderMuniList();
  document.getElementById('loading').style.display = 'none';

  // Fallback
  var matchedSet = new Set(Object.keys(polygonLayers));
  municipalities.forEach(function(m) {
    var k = m.pref+'_'+m.name;
    if (!matchedSet.has(k)) {
      var circle = L.circleMarker([m.lat, m.lng], { radius: 12, fillColor: m.densityColor, fillOpacity: 0.7, color: '#333', weight: 2 });
      circle.bindPopup(buildPopup(m), { className:'custom-popup', maxWidth:340 });
      circle.addTo(map);
      if (!polygonLayers[k]) polygonLayers[k] = [];
      polygonLayers[k].push(circle);
    }
  });
}).catch(function(err) {
  console.error('Load error:', err);
  document.getElementById('loading').innerHTML = '<div style="color:red">読み込みに失敗しました。リロードしてください。</div>';
});

// ---- Sidebar toggle (show/hide entire sidebar) ----
document.getElementById('sidebarToggle').addEventListener('click', function() {
  var sidebar = document.getElementById('sidebar');
  var btn = document.getElementById('sidebarToggle');
  sidebar.classList.toggle('collapsed');
  if (sidebar.classList.contains('collapsed')) {
    btn.textContent = '☰';
    btn.title = '凡例を表示';
    btn.style.right = '10px';
  } else {
    btn.textContent = '✕';
    btn.title = '凡例を非表示';
    btn.style.right = '340px';
  }
});
// Initial state: sidebar visible, button shows close
document.getElementById('sidebarToggle').textContent = '✕';
document.getElementById('sidebarToggle').style.right = '340px';

// ---- Collapsible section toggles ----
document.querySelectorAll('.collapsible-header').forEach(function(header) {
  header.addEventListener('click', function() {
    var targetId = this.getAttribute('data-target');
    var body = document.getElementById(targetId);
    var icon = this.querySelector('.toggle-icon');
    if (body.classList.contains('closed')) {
      body.classList.remove('closed');
      body.style.maxHeight = body.scrollHeight + 'px';
      this.classList.remove('closed');
    } else {
      body.style.maxHeight = body.scrollHeight + 'px';
      // Force reflow
      body.offsetHeight;
      body.style.maxHeight = '0';
      body.classList.add('closed');
      this.classList.add('closed');
    }
  });
  // Set initial max-height for animation
  var targetId = header.getAttribute('data-target');
  var body = document.getElementById(targetId);
  body.style.maxHeight = 'none';
});
</script>
</body>
</html>
